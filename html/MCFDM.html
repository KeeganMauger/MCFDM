
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>ELEC 4700 Assignment 3</title><meta name="generator" content="MATLAB 9.11"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2022-03-18"><meta name="DC.source" content="MCFDM.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>ELEC 4700 Assignment 3</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Monte-Carlo/Finite Difference Method Coupled Simulation</a></li><li><a href="#2">Section 1: Revisiting Assignment 1</a></li><li><a href="#3">Section 1.1: Various Calculations</a></li><li><a href="#4">Section 1.2</a></li><li><a href="#5">Section 1.3</a></li><li><a href="#6">Section 2: Finite Difference Method</a></li><li><a href="#7">Section 2.1</a></li><li><a href="#8">Section 2.2</a></li><li><a href="#9">Section 3: Basic Parameter Extraction</a></li><li><a href="#10">Section 3.1</a></li><li><a href="#11">Section 3.2</a></li></ul></div><h2 id="1">Monte-Carlo/Finite Difference Method Coupled Simulation</h2><p>Keegan Mauger 101042551</p><h2 id="2">Section 1: Revisiting Assignment 1</h2><p>In assignment 1, a Monte-Carlo simulator to emulate the movement of electrons was developed. For section one, the simulator without the bottlenecks will be updated.</p><h2 id="3">Section 1.1: Various Calculations</h2><p>Note that these values were found with the simulation ran at the time of writing this report, but due to the inherent randomness of the Monte-Carlo simulation, the generated values will likely be different. With an applied voltage of 0.1V over the x dimension, the electric field on the electrons was found to be $5e5$V/m. Using this, the force on each electron was calculated to be approximately 8.0109N. With the force, the acceleration on each electron was calculated to be approximately $3.38e17$m/s^2. Next, the current in the x dimension was calculated using the formula Ix = (e*n*v_dx)(W*L), the meaning of which is described below.</p><p>It was seen that the current density and the average carrier velocity are proportional, where an increase in one leads to an increase in the other.</p><pre class="codeinput"><span class="comment">% Initialization</span>

clear <span class="string">all</span>
close <span class="string">all</span>
clc
figure(2)
<span class="comment">%set(0,'DefaultFigureWindowStyle','docked')</span>
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);



<span class="keyword">global</span> C

C.q_0 = 1.60217653e-19;             <span class="comment">% electron charge</span>
C.hb = 1.054571596e-34;             <span class="comment">% Dirac constant</span>
C.h = C.hb * 2 * pi;                <span class="comment">% Planck constant</span>
C.m_0 = 9.10938215e-31;             <span class="comment">% electron mass</span>
C.kb = 1.3806504e-23;               <span class="comment">% Boltzmann constant</span>
C.eps_0 = 8.854187817e-12;          <span class="comment">% vacuum permittivity</span>
C.mu_0 = 1.2566370614e-6;           <span class="comment">% vacuum permeability</span>
C.c = 299792458;                    <span class="comment">% speed of light</span>
C.g = 9.80665;                      <span class="comment">% metres (32.1740 ft) per s&sup2;</span>
C.m_n = 0.26 * C.m_0;               <span class="comment">% effective electron mass</span>
C.am = 1.66053892e-27;              <span class="comment">% atomic mass unit</span>
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

figure(1)
temp = C.T;
subplot(2,1,1);
rectangle(<span class="string">'Position'</span>,[0 0 200e-9 100e-9])
hold <span class="string">on</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Initializing Positions</span>
<span class="comment">%--------------------------------------------------------------------------</span>


N = 30000;        <span class="comment">% Number of electrons</span>
i = 0;
j = 0;

<span class="keyword">for</span> i=1:N
    px(i) = 0 + (200e-9 - 0).*rand(1,1);
    py(i) = 0 + (100e-9 - 0).*rand(1,1);
<span class="keyword">end</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Voltage Applied Across x-Dimension to Find Electric Field</span>
<span class="comment">%--------------------------------------------------------------------------</span>

V0x = 0.1;
V0y = 0;
L = 200e-9;
W = 100e-9;
E0x = V0x / L;
E0y = V0y / W;
fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
<span class="comment">% G = sparse(nx,ny);</span>
<span class="comment">% F = sparse(1,nx*ny);</span>

La = linspace(0,L,nx);
Wa = linspace(0,W,ny);

Emapx = zeros(ny,nx);
Emapy = zeros(ny,nx);
<span class="keyword">for</span> i = 1:width(La)
    <span class="keyword">for</span> j = 1:width(Wa)
        Emapx(j,i) = E0x;
        Emapy(j,i) = E0y;
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">%surf(La,Wa,Emapx)</span>

Fex = abs(C.q_0*E0x);
aex = Fex/C.m_n;
Fey = abs(C.q_0*E0y);
aey = Fey/C.m_n;


<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Thermal Velocity and Direction</span>
<span class="comment">%--------------------------------------------------------------------------</span>

vth = C.vth;

<span class="keyword">for</span> j=1:N
    vx(j) = (vth/sqrt(2))*randn();
    vy(j) = (vth/sqrt(2))*randn();
    vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
<span class="keyword">end</span>


t = 0;
T(1) = 0;
dt = 1e-14;     <span class="comment">% time step</span>

<span class="keyword">for</span> l=1:N           <span class="comment">%Scattering time step</span>
    ndt(l) = dt;
<span class="keyword">end</span>
P_scat = 0;
Tmn = 0.2e-12;

px_prev = 0;
py_prev = 0;
T_prev = 0;
vx_total = 0;
vy_total = 0;

sampleidx = randi(N,10,1);
Ix = 0;
Jx = 0;

<span class="keyword">for</span> t=2:300
    vx_total = 0;
    vy_total = 0;
    <span class="keyword">for</span> k=1:N

        <span class="keyword">if</span> px(k) == 200e-9
            px(k) = 0;
            px_prev(k) = px(k);
        <span class="keyword">elseif</span> px(k) == 0
            px(k) = 200e-9;
            px_prev(k) = px(k);
        <span class="keyword">else</span>
            px(k) = px(k);
        <span class="keyword">end</span>

        P_scat(k) = 1 - exp(-(dt/Tmn));
        <span class="keyword">if</span> P_scat(k) &gt; rand()
            vx(k) = (vth/sqrt(2))*randn();
            vy(k) = (vth/sqrt(2))*randn();
        <span class="keyword">else</span>
            ndt(k) = ndt(k) + dt;
        <span class="keyword">end</span>

        px_prev(k) = px(k);
        px(k) = px(k) + vx(k)*dt + aex*dt^2;        <span class="comment">% Adding acceleration</span>
        vx(k) = vx(k) + aex*dt;
        py_prev(k) = py(k);
        py(k) = py(k) + vy(k)*dt + aey*dt^2;
        vy(k) = vy(k) + aey*dt;

        <span class="keyword">if</span> py(k) &gt;= 100e-9 || py(k) &lt;= 0
            vy(k) = -vy(k);
            <span class="keyword">if</span> py(k) &gt;= 100e-9
                py(k) = 100e-9;
            <span class="keyword">end</span>
            <span class="keyword">if</span> py(k) &lt;= 0
                py(k) = 0;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">if</span> px(k) &gt; 200e-9
            px(k) = 200e-9;
<span class="comment">%             px_prev(k) = px(k);</span>
        <span class="keyword">elseif</span> px(k) &lt; 0
            px(k) = 0;
<span class="comment">%             px_prev(k) = px(k);</span>
        <span class="keyword">else</span>
            px(k) = px(k);
        <span class="keyword">end</span>

        v(k) = sqrt(vx(k)^2 + vy(k)^2);
        v2(k) = v(k).*v(k);

        vx_total = vx_total + vx(k);        <span class="comment">% Drift velocity x</span>
        vy_total = vy_total + vy(k);        <span class="comment">% Drift velocity y</span>
    <span class="keyword">end</span>
    vx_total_alt = sum(vx);
    <span class="keyword">for</span> h=1:length(sampleidx)
        subplot(2,1,1);
        plot([px_prev(sampleidx(h)) px(sampleidx(h))],[py_prev(sampleidx(h)) py(sampleidx(h))],<span class="string">'SeriesIndex'</span>,h)
        hold <span class="string">on</span>
    <span class="keyword">end</span>


    vx_drift = 1/N * vx_total;
    vy_drift = 1/N * vy_total;
    Jx = C.q_0 * 1e17 * vx_drift;
    Ix_prev = Ix;
    Ix = Jx * (W*L);


    subplot(2,1,2);
    plot([t-1 t], [Ix_prev Ix], <span class="string">'r'</span>)
    hold <span class="string">on</span>

    KE = 0.5 * C.m_n * mean(v2);
    T_prev = T;
    T = KE / C.kb;
<span class="comment">%     subplot(2,1,2);</span>
<span class="comment">%     plot([t-1 t], [T_prev T],'r')</span>
<span class="comment">%     hold on</span>

    pause(0.01)
<span class="keyword">end</span>

T_T_C = mean(ndt);
MFP = mean(v)*mean(ndt);

disp(<span class="string">'Section 1'</span>)
fprintf(<span class="keyword">...</span>
<span class="string">'\nFor an applied voltage of %f V across the x dimension, the electric field on the electrons is %e V/m.'</span><span class="keyword">...</span>
,V0x,E0x)
fprintf(<span class="string">'\n\nWith the electric field of %e V/m, the force on each electron is %e N.'</span>,E0x,Fex)
fprintf(<span class="string">'\n\nWith the force known, the acceleration of each electron is %e m/s^2.'</span>,aex)
fprintf(<span class="string">'\n\nThe formula to find current in the x dimension is: Ix = (e*n*v_dx)(W*L)'</span>)
fprintf(<span class="string">'\nWhere:'</span>)
fprintf(<span class="string">'\ne is the electron charge'</span>)
fprintf(<span class="string">'\nn is the concentration of electrons'</span>)
fprintf(<span class="string">'\nv_dx is the drift velocity of the electrons in the x direction'</span>)
fprintf(<span class="string">'\nW and L are the region width and length'</span>)
</pre><pre class="codeoutput">Section 1

For an applied voltage of 0.100000 V across the x dimension, the electric field on the electrons is 5.000000e+05 V/m.

With the electric field of 5.000000e+05 V/m, the force on each electron is 8.010883e-14 N.

With the force known, the acceleration of each electron is 3.382347e+17 m/s^2.

The formula to find current in the x dimension is: Ix = (e*n*v_dx)(W*L)
Where:
e is the electron charge
n is the concentration of electrons
v_dx is the drift velocity of the electrons in the x direction
W and L are the region width and length</pre><img vspace="5" hspace="5" src="MCFDM_01.png" alt=""> <h2 id="4">Section 1.2</h2><p>The Monte-Carlo simulation was modified to model the effects of acceleration, previously calculated, on the electrons. The result was that the electrons were able to respond to the effects of a static electric field present in both the x and y axis, represented by the acceleration on the particles. The trajectories of the electrons were then plotted, where the curve as a result of acceleration can be seen. Additionally, the current over time was modelled and displayed. It can be seen that the current remains at approximately the same value, due to a relatively constant electron drift velocity over time.</p><pre class="codeinput">subplot(2,1,1);
title(<span class="string">'Maxwell-Boltzmann Velocity Distributions of Electrons with Scattering'</span>)
xlabel(<span class="string">'Region Width (m)'</span>)
ylabel(<span class="string">'Region Height (m)'</span>)
subplot(2,1,2);
title(<span class="string">'Current over Time'</span>)
xlabel(<span class="string">'Timesteps (1e-14 s per step)'</span>)
ylabel(<span class="string">'Current (A)'</span>)
<span class="comment">% disp('Section 2')</span>
<span class="comment">% fprintf('\nThe given mean free time between collisions is %e seconds.',Tmn)</span>
<span class="comment">% fprintf('\nThe mean calculated time between collisions is %e seconds.',T_T_C)</span>
<span class="comment">% fprintf('\nThe mean calculated thermal velocity is %e meters per second.',mean(vth_calc))</span>
<span class="comment">% fprintf('\nThe thermal velocity is %e meters per second.',vth)</span>
<span class="comment">% fprintf('\nThe mean free path is %e meters.\n\n\n',MFP)</span>
pause(0.1)
saveas(gcf,<span class="string">'Figure1'</span>)
</pre><img vspace="5" hspace="5" src="MCFDM_02.png" alt=""> <h2 id="5">Section 1.3</h2><p>Finally, the temperature and density plots for the simulated region were generated.</p><pre class="codeinput">E_map = [reshape(px,[N,1]),reshape(py,[N,1])];
figure(2)
subplot(1,2,1);
hist3(E_map,<span class="string">'CDataMode'</span>,<span class="string">'auto'</span>,<span class="string">'FaceColor'</span>,<span class="string">'interp'</span>)
<span class="comment">%view(2)</span>
title(<span class="string">'Electron Density in Modeled Region'</span>)
xlabel(<span class="string">'Region x-Axis (m)'</span>)
ylabel(<span class="string">'Region y-Axis (m)'</span>)
zlabel(<span class="string">'Electron Density'</span>)


Nbins = 21;
d = 1;
u = 1;
vtm = 0;
vbm = 0;
vbm2 = 0;
T_map = zeros(Nbins);
[X,Xe] = discretize(px,Nbins);
[Y,Ye] = discretize(py,Nbins);

<span class="keyword">for</span> e=1:Nbins
    <span class="keyword">for</span> f=1:Nbins
        <span class="keyword">for</span> g=1:N
            <span class="keyword">if</span> X(g) == e &amp;&amp; Y(g) == f
                vtm(d) = v(g);
                vtm2(d) = vtm(d).*vtm(d);
                d = d+1;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    vbm2 = mean(vtm2);
    d = 1;
    T_map(e,f) = (0.5*C.m_n*vbm2)/C.kb;
    <span class="keyword">end</span>
<span class="keyword">end</span>

[V,W] = meshgrid(0:1e-8:2e-7,0:0.5e-8:1e-7);
subplot(1,2,2);
surf(V,W,T_map,<span class="string">'FaceColor'</span>,<span class="string">'interp'</span>)
<span class="comment">%view(2)</span>
title(<span class="string">'Temperature Map of Modeled Region'</span>)
xlabel(<span class="string">'Region x-Axis (m)'</span>)
ylabel(<span class="string">'Region y-Axis (m)'</span>)
zlabel(<span class="string">'Temperature (K)'</span>)
saveas(gcf,<span class="string">'Figure2'</span>)
</pre><img vspace="5" hspace="5" src="MCFDM_03.png" alt=""> <h2 id="6">Section 2: Finite Difference Method</h2><p>Using assignment 2, the finite difference method was used to calculate the electric field for the Monte-Carlo bottleneck simulation.</p><h2 id="7">Section 2.1</h2><p>First, the code from assignment 2 was reused to calculate the potential of the region with included bottleneck, shown below. Additionally, the electric field of the region was calculated in a quiver plot.</p><pre class="codeinput">clear <span class="string">all</span>
<span class="comment">%close all</span>
clc
<span class="comment">%set(0,'DefaultFigureWindowStyle','docked')</span>
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Finite Difference Method Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>

<span class="comment">% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW</span>
<span class="comment">% Implement funtion 'pbaspect' to fix Z aspect ratio</span>

L = 200e-9;
W = 100e-9;
V0 = 0.1;

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
<span class="comment">%V = sparse(nx,ny);</span>
F = sparse(1,nx*ny);


Acond = 1;              <span class="comment">% background conductivity of region, low resistance</span>
Bcond = 1e-2;           <span class="comment">% Conductivity of boxes, highly resistive</span>
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
<span class="keyword">for</span> u = 1:nx
    <span class="keyword">for</span> v = 1:ny
        <span class="keyword">if</span> (u &gt;= 80 &amp;&amp; u &lt;= 120)
            <span class="keyword">if</span> v &gt;= 0 &amp;&amp; v &lt;= 40
                cMap(u,v) = Bcond;
            <span class="keyword">elseif</span> v &gt;= 60 &amp;&amp; v &lt;= 100
                cMap(u,v) = Bcond;
            <span class="keyword">else</span>
                cMap(u,v) = Acond;
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            cMap(u,v) = Acond;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>





<span class="keyword">for</span> i = 1:nx                <span class="comment">%Iteration through length</span>
    <span class="keyword">for</span> j = 1:ny            <span class="comment">%Iteration through width</span>
        n = j + (i-1)*ny;

        <span class="keyword">if</span> i == 1          <span class="comment">% x=0 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        <span class="keyword">elseif</span> i == nx     <span class="comment">% x=1 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       <span class="comment">%F(n)=0 sets z at final width to 0</span>

<span class="comment">% COMMENT BELOW FOR 1a</span>
            <span class="comment">%F(n) = 1;       %F(n)=1 sets z at final width to 1</span>

        <span class="keyword">elseif</span> j == 1                 <span class="comment">% y=0 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        <span class="keyword">elseif</span> j == ny                <span class="comment">% y=1 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;

            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;


<span class="comment">% COMMENT ABOVE FOR 1a</span>

        <span class="keyword">else</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        <span class="keyword">end</span>

    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% figure(1)</span>
<span class="comment">% spy(G)</span>

V = G\F';

Vmap = zeros(nx,ny);
<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        <span class="keyword">if</span> i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        <span class="keyword">elseif</span> i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        <span class="keyword">else</span>
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        <span class="keyword">end</span>
        <span class="keyword">if</span> j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        <span class="keyword">elseif</span> j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        <span class="keyword">else</span>
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        <span class="comment">%Jx</span>
eFlowy = cMap .* Ey;        <span class="comment">%Jy</span>
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

figure(3)
subplot(1, 2, 2), quiver(Ex, Ey);
axis([0 nx 0 ny]);
title(<span class="string">'Electric Field Map'</span>)
xlabel(<span class="string">'Region Length'</span>)
ylabel(<span class="string">'Region Width'</span>)
pbaspect([1 1 0.5])
subplot(1, 2, 1), H = surf(La,Wa,Vmap');
set(H, <span class="string">'linestyle'</span>, <span class="string">'none'</span>);
<span class="comment">%view(90, 270)</span>
title(<span class="string">'Voltage Map'</span>)
xlabel(<span class="string">'Region Length'</span>)
ylabel(<span class="string">'Region Width'</span>)
pbaspect([1 1 0.5])
saveas(gcf,<span class="string">'Figure3'</span>)

clearvars <span class="string">-except</span> <span class="string">Ex</span> <span class="string">Ey</span>
</pre><img vspace="5" hspace="5" src="MCFDM_04.png" alt=""> <h2 id="8">Section 2.2</h2><p>Using the calculated electric field as an input to the Monte-Carlo simulation, the trajectories of the electrons were then plotted. The number of timesteps used in previous simulations was altered from 300 to 1000, while the number of electrons (30000) remained unchanged.</p><pre class="codeinput"><span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Beginning Monte Carlo Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>


set(0,<span class="string">'DefaultFigureWindowStyle'</span>,<span class="string">'docked'</span>)
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);



<span class="keyword">global</span> C

C.q_0 = 1.60217653e-19;             <span class="comment">% electron charge</span>
C.hb = 1.054571596e-34;             <span class="comment">% Dirac constant</span>
C.h = C.hb * 2 * pi;                <span class="comment">% Planck constant</span>
C.m_0 = 9.10938215e-31;             <span class="comment">% electron mass</span>
C.kb = 1.3806504e-23;               <span class="comment">% Boltzmann constant</span>
C.eps_0 = 8.854187817e-12;          <span class="comment">% vacuum permittivity</span>
C.mu_0 = 1.2566370614e-6;           <span class="comment">% vacuum permeability</span>
C.c = 299792458;                    <span class="comment">% speed of light</span>
C.g = 9.80665;                      <span class="comment">% metres (32.1740 ft) per s&sup2;</span>
C.m_n = 0.26 * C.m_0;               <span class="comment">% effective electron mass</span>
C.am = 1.66053892e-27;              <span class="comment">% atomic mass unit</span>
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

figure(4)
subplot(2,1,1);
rectangle(<span class="string">'Position'</span>,[0 0 200e-9 100e-9])
hold <span class="string">on</span>
rectangle(<span class="string">'Position'</span>,[0.8e-7 0 0.4e-7 0.4e-7])
hold <span class="string">on</span>
rectangle(<span class="string">'Position'</span>,[0.8e-7 0.6e-7 0.4e-7 0.4e-7])
hold <span class="string">on</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Initializing Positions</span>
<span class="comment">%--------------------------------------------------------------------------</span>


N = 30000;        <span class="comment">% Number of electrons</span>
i = 0;
j = 0;

<span class="keyword">for</span> i=1:N
    px(i) = 0 + (200e-9 - 0).*rand(1,1);
    py(i) = 0 + (100e-9 - 0).*rand(1,1);
    <span class="keyword">while</span> (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; (0 &lt;= py(i) &amp;&amp; py(i) &lt;= 0.4e-7) ||<span class="keyword">...</span>
    (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; (0.6e-7 &lt;= py(i) &amp;&amp; py(i) &lt;= 1e-7)
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Voltage Applied Across x-Dimension to Find Electric Field</span>
<span class="comment">%--------------------------------------------------------------------------</span>

V0x = 0.1;
V0y = 0;
L = 200e-9;
W = 100e-9;
<span class="comment">% E0x = V0x / L;</span>
<span class="comment">% E0y = V0y / W;</span>
fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
<span class="comment">% G = sparse(nx,ny);</span>
<span class="comment">% F = sparse(1,nx*ny);</span>

La = linspace(0,L,nx);
Wa = linspace(0,W,ny);

deltax = L/nx;
deltay = W/ny;

Ex = Ex./deltax;
Ey = Ey./deltay;

<span class="comment">% Emapx = zeros(ny,nx);</span>
Emapx = Ex;
<span class="comment">% Emapy = zeros(ny,nx);</span>
Emapy = Ey;

<span class="comment">% for i = 1:width(La)</span>
<span class="comment">%     for j = 1:width(Wa)</span>
<span class="comment">%         Emapx(j,i) = E0x;</span>
<span class="comment">%         Emapy(j,i) = E0y;</span>
<span class="comment">%     end</span>
<span class="comment">% end</span>
<span class="comment">% %surf(La,Wa,Emapx)</span>
<span class="comment">%</span>
<span class="comment">% Fex = abs(C.q_0*E0x);</span>
<span class="comment">% aex = Fex/C.m_n;</span>
<span class="comment">% Fey = abs(C.q_0*E0y);</span>
<span class="comment">% aey = Fey/C.m_n;</span>

Fex = zeros(ny,nx);
aex = zeros(ny,nx);
Fey = zeros(ny,nx);
aey = zeros(ny,nx);

<span class="keyword">for</span> i = 1:width(Wa)
    <span class="keyword">for</span> j = 1:width(La)
        Fex(i,j) = abs(C.q_0*Emapx(i,j));
        aex(i,j) = Fex(i,j)/C.m_n;
        Fey(i,j) = abs(C.q_0*Emapy(i,j));
        aey(i,j) = Fey(i,j)/C.m_n;
    <span class="keyword">end</span>
<span class="keyword">end</span>





<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Thermal Velocity and Direction</span>
<span class="comment">%--------------------------------------------------------------------------</span>

vth = C.vth;

<span class="keyword">for</span> j=1:N
    vx(j) = (vth/sqrt(2))*randn();
    vy(j) = (vth/sqrt(2))*randn();
    vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
<span class="keyword">end</span>


t = 0;
T(1) = 0;
dt = 1e-14;     <span class="comment">% time step</span>

<span class="keyword">for</span> l=1:N           <span class="comment">%Scattering time step</span>
    ndt(l) = dt;
<span class="keyword">end</span>
P_scat = 0;
Tmn = 0.2e-12;

px_prev = 0;
py_prev = 0;
T_prev = 0;
vx_total = 0;
vy_total = 0;

sampleidx = randi(N,10,1);
Ix = 0;
Jx = 0;
aex = aex';
aey = aey';

<span class="comment">% aex(:,:) = 3e17;    % Testing acceleration</span>
<span class="comment">% aey(:,:) = 0;</span>

<span class="keyword">for</span> t=2:1000
    vx_total = 0;
    vy_total = 0;
    <span class="keyword">for</span> k=1:N

        rpx = 0;
        rpy = 0;
        <span class="keyword">if</span> px(k) == 200e-9
            px(k) = 0;
            px_prev(k) = px(k);
        <span class="keyword">elseif</span> px(k) == 0
            px(k) = 200e-9;
            px_prev(k) = px(k);
        <span class="keyword">else</span>
            px(k) = px(k);
        <span class="keyword">end</span>

        P_scat(k) = 1 - exp(-(dt/Tmn));
        <span class="keyword">if</span> P_scat(k) &gt; rand()
            vx(k) = (vth/sqrt(2))*randn();
            vy(k) = (vth/sqrt(2))*randn();
        <span class="keyword">else</span>
            ndt(k) = ndt(k) + dt;
        <span class="keyword">end</span>

        px_prev(k) = px(k);
        py_prev(k) = py(k);

        rpx = round(px(k)*1e9);
        <span class="keyword">if</span> rpx == 0
            rpx = 1;
        <span class="keyword">end</span>
        rpy = round(py(k)*1e9);
        <span class="keyword">if</span> rpy == 0
            rpy = 1;
        <span class="keyword">end</span>



        px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        <span class="comment">% Adding acceleration</span>
        vx(k) = vx(k) + aex(rpx,rpy)*dt;
        py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
        vy(k) = vy(k) + aey(rpx,rpy)*dt;


        <span class="comment">% Reflection on top and bottom borders</span>
        <span class="keyword">if</span> py(k) &gt;= 100e-9 || py(k) &lt;= 0
            vy(k) = -vy(k);
            <span class="keyword">if</span> py(k) &gt;= 100e-9
                py(k) = 100e-9;
            <span class="keyword">end</span>
            <span class="keyword">if</span> py(k) &lt;= 0
                py(k) = 0;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="comment">% Reflection on bottom of upper box</span>
        <span class="keyword">if</span> (py(k) &gt;= 0.6e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
           &amp;&amp; ( 0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vy(k) = -vy(k);
            <span class="keyword">end</span>
            py(k) = 0.601e-7;
        <span class="comment">%end</span>
        <span class="comment">% Reflection on top of lower box</span>
        <span class="keyword">elseif</span> (py(k) &lt;= 0.4e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
               &amp;&amp; (0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vy(k) = -vy(k);
            <span class="keyword">end</span>
            py(k) = 0.399e-7;
        <span class="comment">%end</span>
        <span class="comment">% Reflection on left of lower box</span>
        <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vx(k) = -vx(k);
            <span class="keyword">end</span>
            px(k) = 0.799e-7;
        <span class="comment">%end</span>
        <span class="comment">% Reflection on right of lower box</span>
        <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vx(k) = -vx(k);
            <span class="keyword">end</span>
            px(k) = 1.201e-7;
        <span class="comment">%end</span>
        <span class="comment">% Reflection on left of upper box</span>
        <span class="keyword">elseif</span> (0.6e-7 &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vx(k) = -vx(k);
            <span class="keyword">end</span>
            px(k) = 0.799e-7;
        <span class="comment">%end</span>
        <span class="comment">% Reflection on right of upper box</span>
        <span class="keyword">elseif</span> (0.6e-7 &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
            <span class="keyword">if</span> SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                vx(k) = -vx(k);
            <span class="keyword">end</span>
            px(k) = 1.201e-7;
        <span class="keyword">end</span>

        <span class="comment">% x-axis transition</span>
        <span class="keyword">if</span> px(k) &gt; 200e-9
            px(k) = 200e-9;
<span class="comment">%             px_prev(k) = px(k);</span>
        <span class="keyword">elseif</span> px(k) &lt; 0
            px(k) = 0;
<span class="comment">%             px_prev(k) = px(k);</span>
        <span class="keyword">else</span>
            px(k) = px(k);
        <span class="keyword">end</span>

        v(k) = sqrt(vx(k)^2 + vy(k)^2);
        v2(k) = v(k).*v(k);

        vx_total = vx_total + vx(k);        <span class="comment">% Drift velocity x</span>
        vy_total = vy_total + vy(k);        <span class="comment">% Drift velocity y</span>
    <span class="keyword">end</span>
    vx_total_alt = sum(vx);
    <span class="keyword">for</span> h=1:length(sampleidx)
        subplot(2,1,1);
        plot([px_prev(sampleidx(h)) px(sampleidx(h))],[py_prev(sampleidx(h)) py(sampleidx(h))],<span class="string">'SeriesIndex'</span>,h)
        hold <span class="string">on</span>
    <span class="keyword">end</span>


    vx_drift = 1/N * vx_total;
    vy_drift = 1/N * vy_total;
    Jx = C.q_0 * 1e17 * vx_drift;
    Ix_prev = Ix;
    Ix = Jx * (W*L);
    Ix_total(t) = Ix;


    subplot(2,1,2);
    plot([t-1 t], [Ix_prev Ix], <span class="string">'r'</span>)
    hold <span class="string">on</span>

    KE = 0.5 * C.m_n * mean(v2);
    T_prev = T;
    T = KE / C.kb;
<span class="comment">%     subplot(2,1,2);</span>
<span class="comment">%     plot([t-1 t], [T_prev T],'r')</span>
<span class="comment">%     hold on</span>

    pause(0.01)
<span class="keyword">end</span>

T_T_C = mean(ndt);
MFP = mean(v)*mean(ndt);

subplot(2,1,1);
title(<span class="string">'Maxwell-Boltzmann Velocity Distributions of Electrons with Scattering'</span>)
xlabel(<span class="string">'Region Length (m)'</span>)
ylabel(<span class="string">'Region Width (m)'</span>)
subplot(2,1,2);
title(<span class="string">'Current over Time'</span>)
xlabel(<span class="string">'Timesteps (1e-14 s per step)'</span>)
ylabel(<span class="string">'Current (A)'</span>)
<span class="comment">% disp('Section 2')</span>
<span class="comment">% fprintf('\nThe given mean free time between collisions is %e seconds.',Tmn)</span>
<span class="comment">% fprintf('\nThe mean calculated time between collisions is %e seconds.',T_T_C)</span>
<span class="comment">% fprintf('\nThe mean calculated thermal velocity is %e meters per second.',mean(vth_calc))</span>
<span class="comment">% fprintf('\nThe thermal velocity is %e meters per second.',vth)</span>
<span class="comment">% fprintf('\nThe mean free path is %e meters.\n\n\n',MFP)</span>
pause(0.1)
saveas(gcf,<span class="string">'Figure4'</span>)
</pre><img vspace="5" hspace="5" src="MCFDM_05.png" alt=""> <h2 id="9">Section 3: Basic Parameter Extraction</h2><p>Various operations of the simulation were examined to observe the function of the model, beginning with a density plot.</p><h2 id="10">Section 3.1</h2><p>First, the electron density map was plotted. It can be seen that the bottleneck severly restricts the flow of electrons, resulting in a greater concentration on the left side of the block, where the acceleration has forced the particles due to the transition from the right border of the model to the left.</p><pre class="codeinput">E_map = [reshape(px,[N,1]),reshape(py,[N,1])];
figure(5)
hist3(E_map,<span class="string">'CDataMode'</span>,<span class="string">'auto'</span>,<span class="string">'FaceColor'</span>,<span class="string">'interp'</span>)
<span class="comment">%view(2)</span>
title(<span class="string">'Electron Density in Modeled Region'</span>)
xlabel(<span class="string">'Region x-Axis (m)'</span>)
ylabel(<span class="string">'Region y-Axis (m)'</span>)
zlabel(<span class="string">'Electron Density'</span>)
saveas(gcf,<span class="string">'Figure5'</span>)
</pre><img vspace="5" hspace="5" src="MCFDM_06.png" alt=""> <h2 id="11">Section 3.2</h2><p>To begin, the number of time steps was reduced from 1000 back to the original value of 300, as the next simulation was noted to require a large amount of time. The simulation modelled the effects of varying bottleneck widths, and the result was compared to the average current. It can be seen that an increase in the bottleneck gap corresponds to an increase in the average current.</p><p>The next step in making the simulation more accurate would be to model the y-dimension more accurately. At present, the current and drift only account for the x-dimension, despite an electric field also existing in the y-dimension. Updating the model to account for this would result in a better representation of the particle flows.</p><pre class="codeinput">clear <span class="string">all</span>
<span class="comment">%close all</span>
clc
<span class="comment">%set(0,'DefaultFigureWindowStyle','docked')</span>
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Finite Difference Method Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>
<span class="keyword">for</span> J=1:10
g = J*1e-9;
<span class="comment">% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW</span>
<span class="comment">% Implement funtion 'pbaspect' to fix Z aspect ratio</span>
clearvars <span class="string">-except</span> <span class="string">bottleneck</span> <span class="string">g</span> <span class="string">J</span> <span class="string">Ix_total</span> <span class="string">Iavg</span>

L = 200e-9;
W = 100e-9;
V0 = 0.1;

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
<span class="comment">%V = sparse(nx,ny);</span>
F = sparse(1,nx*ny);


Acond = 1;              <span class="comment">% background conductivity of region, low resistance</span>
Bcond = 1e-2;           <span class="comment">% Conductivity of boxes, highly resistive</span>
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
<span class="keyword">for</span> u = 1:nx
    <span class="keyword">for</span> v = 1:ny
        <span class="keyword">if</span> (u &gt;= 80 &amp;&amp; u &lt;= 120)
            <span class="keyword">if</span> v &gt;= 0 &amp;&amp; v &lt;= 40-1+J
                cMap(u,v) = Bcond;
            <span class="keyword">elseif</span> v &gt;= 60+1-J &amp;&amp; v &lt;= 100
                cMap(u,v) = Bcond;
            <span class="keyword">else</span>
                cMap(u,v) = Acond;
            <span class="keyword">end</span>
        <span class="keyword">else</span>
            cMap(u,v) = Acond;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>





<span class="keyword">for</span> i = 1:nx                <span class="comment">%Iteration through length</span>
    <span class="keyword">for</span> j = 1:ny            <span class="comment">%Iteration through width</span>
        n = j + (i-1)*ny;

        <span class="keyword">if</span> i == 1          <span class="comment">% x=0 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        <span class="keyword">elseif</span> i == nx     <span class="comment">% x=1 BCs</span>
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       <span class="comment">%F(n)=0 sets z at final width to 0</span>

<span class="comment">% COMMENT BELOW FOR 1a</span>
            <span class="comment">%F(n) = 1;       %F(n)=1 sets z at final width to 1</span>

        <span class="keyword">elseif</span> j == 1                 <span class="comment">% y=0 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        <span class="keyword">elseif</span> j == ny                <span class="comment">% y=1 BCs</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;

            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;


<span class="comment">% COMMENT ABOVE FOR 1a</span>

        <span class="keyword">else</span>
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;

            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        <span class="keyword">end</span>

    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">% figure(1)</span>
<span class="comment">% spy(G)</span>

V = G\F';

Vmap = zeros(nx,ny);
<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    <span class="keyword">end</span>
<span class="keyword">end</span>


<span class="keyword">for</span> i = 1:nx
    <span class="keyword">for</span> j = 1:ny
        <span class="keyword">if</span> i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        <span class="keyword">elseif</span> i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        <span class="keyword">else</span>
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        <span class="keyword">end</span>
        <span class="keyword">if</span> j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        <span class="keyword">elseif</span> j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        <span class="keyword">else</span>
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        <span class="comment">%Jx</span>
eFlowy = cMap .* Ey;        <span class="comment">%Jy</span>
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

<span class="comment">% figure(4)</span>
<span class="comment">% subplot(1, 2, 2), quiver(Ex, Ey);</span>
<span class="comment">% axis([0 nx 0 ny]);</span>
<span class="comment">% title('Electric Field Map')</span>
<span class="comment">% xlabel('Region Length')</span>
<span class="comment">% ylabel('Region Width')</span>
<span class="comment">% pbaspect([1 1 0.5])</span>
<span class="comment">% subplot(1, 2, 1), H = surf(La,Wa,Vmap');</span>
<span class="comment">% set(H, 'linestyle', 'none');</span>
<span class="comment">% %view(90, 270)</span>
<span class="comment">% title('Voltage Map')</span>
<span class="comment">% xlabel('Region Length')</span>
<span class="comment">% ylabel('Region Width')</span>
<span class="comment">% pbaspect([1 1 0.5])</span>
<span class="comment">% saveas(gcf,'Figure4')</span>

<span class="comment">% clearvars -except Ex Ey</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Beginning Monte Carlo Simulation</span>
<span class="comment">%--------------------------------------------------------------------------</span>


set(0,<span class="string">'DefaultFigureWindowStyle'</span>,<span class="string">'docked'</span>)
set(0,<span class="string">'defaultaxesfontsize'</span>,10)
set(0,<span class="string">'defaultaxesfontname'</span>,<span class="string">'Times New Roman'</span>)
set(0,<span class="string">'DefaultLineLineWidth'</span>, 0.5);



<span class="keyword">global</span> C

C.q_0 = 1.60217653e-19;             <span class="comment">% electron charge</span>
C.hb = 1.054571596e-34;             <span class="comment">% Dirac constant</span>
C.h = C.hb * 2 * pi;                <span class="comment">% Planck constant</span>
C.m_0 = 9.10938215e-31;             <span class="comment">% electron mass</span>
C.kb = 1.3806504e-23;               <span class="comment">% Boltzmann constant</span>
C.eps_0 = 8.854187817e-12;          <span class="comment">% vacuum permittivity</span>
C.mu_0 = 1.2566370614e-6;           <span class="comment">% vacuum permeability</span>
C.c = 299792458;                    <span class="comment">% speed of light</span>
C.g = 9.80665;                      <span class="comment">% metres (32.1740 ft) per s&sup2;</span>
C.m_n = 0.26 * C.m_0;               <span class="comment">% effective electron mass</span>
C.am = 1.66053892e-27;              <span class="comment">% atomic mass unit</span>
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

<span class="comment">% figure(3)</span>
<span class="comment">% subplot(2,1,1);</span>
<span class="comment">% rectangle('Position',[0 0 200e-9 100e-9])</span>
<span class="comment">% hold on</span>
<span class="comment">% rectangle('Position',[0.8e-7 0 0.4e-7 0.4e-7])</span>
<span class="comment">% hold on</span>
<span class="comment">% rectangle('Position',[0.8e-7 0.6e-7 0.4e-7 0.4e-7])</span>
<span class="comment">% hold on</span>

<span class="comment">%--------------------------------------------------------------------------</span>
<span class="comment">% Initializing Positions</span>
<span class="comment">%--------------------------------------------------------------------------</span>

    N = 30000;        <span class="comment">% Number of electrons</span>
    i = 0;
    j = 0;

    <span class="keyword">for</span> i=1:N
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
        <span class="keyword">while</span> (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; (0 &lt;= py(i) &amp;&amp; py(i) &lt;= (0.4e-7 -1e-9 +g) ) ||<span class="keyword">...</span>
                (0.8e-7 &lt;= px(i) &amp;&amp; px(i) &lt;= 1.2e-7) &amp;&amp; ((0.6e-7 +1e-9 -g) &lt;= py(i) &amp;&amp; py(i) &lt;= 1e-7)
            px(i) = 0 + (200e-9 - 0).*rand(1,1);
            py(i) = 0 + (100e-9 - 0).*rand(1,1);
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%--------------------------------------------------------------------------</span>
    <span class="comment">% Voltage Applied Across x-Dimension to Find Electric Field</span>
    <span class="comment">%--------------------------------------------------------------------------</span>

    V0x = 0.1;
    V0y = 0;
    L = 200e-9;
    W = 100e-9;
    <span class="comment">% E0x = V0x / L;</span>
    <span class="comment">% E0y = V0y / W;</span>
    fMesh = 1;
    nx = fMesh*200;
    ny = fMesh*100;
    <span class="comment">% G = sparse(nx,ny);</span>
    <span class="comment">% F = sparse(1,nx*ny);</span>

    La = linspace(0,L,nx);
    Wa = linspace(0,W,ny);

    deltax = L/nx;
    deltay = W/ny;

    Ex = Ex./deltax;
    Ey = Ey./deltay;

    <span class="comment">% Emapx = zeros(ny,nx);</span>
    Emapx = Ex;
    <span class="comment">% Emapy = zeros(ny,nx);</span>
    Emapy = Ey;

    <span class="comment">% for i = 1:width(La)</span>
    <span class="comment">%     for j = 1:width(Wa)</span>
    <span class="comment">%         Emapx(j,i) = E0x;</span>
    <span class="comment">%         Emapy(j,i) = E0y;</span>
    <span class="comment">%     end</span>
    <span class="comment">% end</span>
    <span class="comment">% %surf(La,Wa,Emapx)</span>
    <span class="comment">%</span>
    <span class="comment">% Fex = abs(C.q_0*E0x);</span>
    <span class="comment">% aex = Fex/C.m_n;</span>
    <span class="comment">% Fey = abs(C.q_0*E0y);</span>
    <span class="comment">% aey = Fey/C.m_n;</span>

    Fex = zeros(ny,nx);
    aex = zeros(ny,nx);
    Fey = zeros(ny,nx);
    aey = zeros(ny,nx);

    <span class="keyword">for</span> i = 1:width(Wa)
        <span class="keyword">for</span> j = 1:width(La)
            Fex(i,j) = abs(C.q_0*Emapx(i,j));
            aex(i,j) = Fex(i,j)/C.m_n;
            Fey(i,j) = abs(C.q_0*Emapy(i,j));
            aey(i,j) = Fey(i,j)/C.m_n;
        <span class="keyword">end</span>
    <span class="keyword">end</span>





    <span class="comment">%--------------------------------------------------------------------------</span>
    <span class="comment">% Thermal Velocity and Direction</span>
    <span class="comment">%--------------------------------------------------------------------------</span>

    vth = C.vth;

    <span class="keyword">for</span> j=1:N
        vx(j) = (vth/sqrt(2))*randn();
        vy(j) = (vth/sqrt(2))*randn();
        vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
    <span class="keyword">end</span>


    t = 0;
    T(1) = 0;
    dt = 1e-14;     <span class="comment">% time step</span>

    <span class="keyword">for</span> l=1:N           <span class="comment">%Scattering time step</span>
        ndt(l) = dt;
    <span class="keyword">end</span>
    P_scat = 0;
    Tmn = 0.2e-12;

    px_prev = 0;
    py_prev = 0;
    T_prev = 0;
    vx_total = 0;
    vy_total = 0;

    sampleidx = randi(N,10,1);
    Ix = 0;
    Jx = 0;
    aex = aex';
    aey = aey';




    <span class="keyword">for</span> t=2:300
        vx_total = 0;
        vy_total = 0;
        <span class="keyword">for</span> k=1:N

            rpx = 0;
            rpy = 0;
            <span class="keyword">if</span> px(k) == 200e-9
                px(k) = 0;
                px_prev(k) = px(k);
            <span class="keyword">elseif</span> px(k) == 0
                px(k) = 200e-9;
                px_prev(k) = px(k);
            <span class="keyword">else</span>
                px(k) = px(k);
            <span class="keyword">end</span>

            P_scat(k) = 1 - exp(-(dt/Tmn));
            <span class="keyword">if</span> P_scat(k) &gt; rand()
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            <span class="keyword">else</span>
                ndt(k) = ndt(k) + dt;
            <span class="keyword">end</span>

            px_prev(k) = px(k);
            py_prev(k) = py(k);

            rpx = round(px(k)*1e9);
            <span class="keyword">if</span> rpx == 0
                rpx = 1;
            <span class="keyword">end</span>
            rpy = round(py(k)*1e9);
            <span class="keyword">if</span> rpy == 0
                rpy = 1;
            <span class="keyword">end</span>



            px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        <span class="comment">% Adding acceleration</span>
            vx(k) = vx(k) + aex(rpx,rpy)*dt;
            py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
            vy(k) = vy(k) + aey(rpx,rpy)*dt;


            <span class="comment">% Reflection on top and bottom borders</span>
            <span class="keyword">if</span> py(k) &gt;= 100e-9 || py(k) &lt;= 0
                vy(k) = -vy(k);
                <span class="keyword">if</span> py(k) &gt;= 100e-9
                    py(k) = 100e-9;
                <span class="keyword">end</span>
                <span class="keyword">if</span> py(k) &lt;= 0
                    py(k) = 0;
                <span class="keyword">end</span>
            <span class="keyword">end</span>
            <span class="comment">% Reflection on bottom of upper box</span>
            <span class="keyword">if</span> (py(k) &gt;= (0.6e-7 +1e-9 -g)) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
                    &amp;&amp; ( 0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vy(k) = -vy(k);
                <span class="keyword">end</span>
                py(k) = 0.601e-7 +1e-9 -g;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on top of lower box</span>
            <span class="keyword">elseif</span> (py(k) &lt;= 0.4e-7 -1e-9 +g) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)<span class="keyword">...</span>
                    &amp;&amp; (0.8e-7 &lt;= px_prev(k) &amp;&amp; px_prev(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vy(k) = -vy(k);
                <span class="keyword">end</span>
                py(k) = 0.399e-7 -1e-9 +g;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on left of lower box</span>
            <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 0.799e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on right of lower box</span>
            <span class="keyword">elseif</span> (0 &lt;= py(k) &amp;&amp; py(k) &lt;= 0.4e-7) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 1.201e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on left of upper box</span>
            <span class="keyword">elseif</span> (0.6e-7 &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (0.8e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 0.799e-7;
                <span class="comment">%end</span>
                <span class="comment">% Reflection on right of upper box</span>
            <span class="keyword">elseif</span> (0.6e-7 &lt;= py(k) &amp;&amp; py(k) &lt;= 1e-7) &amp;&amp; (1e-7 &lt;= px(k) &amp;&amp; px(k) &lt;= 1.2e-7)
                <span class="keyword">if</span> SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                <span class="keyword">else</span>
                    vx(k) = -vx(k);
                <span class="keyword">end</span>
                px(k) = 1.201e-7;
            <span class="keyword">end</span>

            <span class="comment">% x-axis transition</span>
            <span class="keyword">if</span> px(k) &gt; 200e-9
                px(k) = 200e-9;
                <span class="comment">%             px_prev(k) = px(k);</span>
            <span class="keyword">elseif</span> px(k) &lt; 0
                px(k) = 0;
                <span class="comment">%             px_prev(k) = px(k);</span>
            <span class="keyword">else</span>
                px(k) = px(k);
            <span class="keyword">end</span>

            v(k) = sqrt(vx(k)^2 + vy(k)^2);
            v2(k) = v(k).*v(k);

            vx_total = vx_total + vx(k);        <span class="comment">% Drift velocity x</span>
            vy_total = vy_total + vy(k);        <span class="comment">% Drift velocity y</span>
        <span class="keyword">end</span>
        vx_total_alt = sum(vx);



        vx_drift = 1/N * vx_total;
        vy_drift = 1/N * vy_total;
        Jx = C.q_0 * 1e17 * vx_drift;
        Ix_prev = Ix;
        Ix = Jx * (W*L);
        Ix_total(t) = Ix;



    <span class="keyword">end</span>


    Iavg(J) = mean(Ix_total);
    bottleneck(J) = 20e-9 - (2*g) + 2e-9;


<span class="keyword">end</span>

figure(6)
plot(bottleneck,Iavg)
xlabel(<span class="string">'Bottleneck Length(m)'</span>)
ylabel(<span class="string">'Average Current (A)'</span>)
title(<span class="string">'Average Current VS Bottleneck Length'</span>)
saveas(gcf,<span class="string">'Figure6'</span>)
</pre><img vspace="5" hspace="5" src="MCFDM_07.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2021b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% ELEC 4700 Assignment 3
%%% Monte-Carlo/Finite Difference Method Coupled Simulation
% Keegan Mauger
% 101042551

%% Section 1: Revisiting Assignment 1
% In assignment 1, a Monte-Carlo simulator to emulate the movement of
% electrons was developed. For section one, the simulator without the
% bottlenecks will be updated.

%% Section 1.1: Various Calculations
% Note that these values were found with the simulation ran at the time of 
% writing this report, but due to the inherent randomness of the 
% Monte-Carlo simulation, the generated values will likely be different. 
% With an applied voltage of 0.1V over the x dimension, the electric field 
% on the electrons was found to be $5e5$V/m. Using this, the force on each
% electron was calculated to be approximately 8.0109N. With the force, the
% acceleration on each electron was calculated to be approximately
% $3.38e17$m/s^2. Next, the current in the x dimension was calculated using
% the formula Ix = (e*n*v_dx)(W*L), the meaning of which is described
% below.
%
% It was seen that the current density and the average carrier velocity are
% proportional, where an increase in one leads to an increase in the other.

% Initialization

clear all
close all
clc
figure(2)
%set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);



global C

C.q_0 = 1.60217653e-19;             % electron charge
C.hb = 1.054571596e-34;             % Dirac constant
C.h = C.hb * 2 * pi;                % Planck constant
C.m_0 = 9.10938215e-31;             % electron mass
C.kb = 1.3806504e-23;               % Boltzmann constant
C.eps_0 = 8.854187817e-12;          % vacuum permittivity
C.mu_0 = 1.2566370614e-6;           % vacuum permeability
C.c = 299792458;                    % speed of light
C.g = 9.80665;                      % metres (32.1740 ft) per s
C.m_n = 0.26 * C.m_0;               % effective electron mass
C.am = 1.66053892e-27;              % atomic mass unit
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

figure(1)
temp = C.T;
subplot(2,1,1);
rectangle('Position',[0 0 200e-9 100e-9])
hold on

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Initializing Positions
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


N = 30000;        % Number of electrons
i = 0;
j = 0;

for i=1:N
    px(i) = 0 + (200e-9 - 0).*rand(1,1);
    py(i) = 0 + (100e-9 - 0).*rand(1,1);
end

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Voltage Applied Across x-Dimension to Find Electric Field
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

V0x = 0.1;
V0y = 0;
L = 200e-9;
W = 100e-9;
E0x = V0x / L;
E0y = V0y / W;
fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
% G = sparse(nx,ny);
% F = sparse(1,nx*ny);

La = linspace(0,L,nx);
Wa = linspace(0,W,ny);

Emapx = zeros(ny,nx);
Emapy = zeros(ny,nx);
for i = 1:width(La)
    for j = 1:width(Wa)
        Emapx(j,i) = E0x;
        Emapy(j,i) = E0y;
    end
end
%surf(La,Wa,Emapx)

Fex = abs(C.q_0*E0x);
aex = Fex/C.m_n;
Fey = abs(C.q_0*E0y);
aey = Fey/C.m_n;


%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Thermal Velocity and Direction
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

vth = C.vth;

for j=1:N
    vx(j) = (vth/sqrt(2))*randn();                           
    vy(j) = (vth/sqrt(2))*randn();
    vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
end


t = 0;
T(1) = 0;
dt = 1e-14;     % time step

for l=1:N           %Scattering time step
    ndt(l) = dt;
end
P_scat = 0;
Tmn = 0.2e-12;

px_prev = 0;
py_prev = 0;
T_prev = 0;
vx_total = 0;
vy_total = 0;

sampleidx = randi(N,10,1);
Ix = 0;
Jx = 0;

for t=2:300
    vx_total = 0;
    vy_total = 0;
    for k=1:N
        
        if px(k) == 200e-9
            px(k) = 0;
            px_prev(k) = px(k);
        elseif px(k) == 0
            px(k) = 200e-9;
            px_prev(k) = px(k);
        else
            px(k) = px(k);
        end

        P_scat(k) = 1 - exp(-(dt/Tmn));
        if P_scat(k) > rand()
            vx(k) = (vth/sqrt(2))*randn();
            vy(k) = (vth/sqrt(2))*randn();
        else
            ndt(k) = ndt(k) + dt;
        end
        
        px_prev(k) = px(k);
        px(k) = px(k) + vx(k)*dt + aex*dt^2;        % Adding acceleration
        vx(k) = vx(k) + aex*dt;
        py_prev(k) = py(k);
        py(k) = py(k) + vy(k)*dt + aey*dt^2;
        vy(k) = vy(k) + aey*dt;
        
        if py(k) >= 100e-9 || py(k) <= 0
            vy(k) = -vy(k);
            if py(k) >= 100e-9
                py(k) = 100e-9;
            end
            if py(k) <= 0
                py(k) = 0;
            end
        end
        if px(k) > 200e-9
            px(k) = 200e-9;
%             px_prev(k) = px(k);
        elseif px(k) < 0
            px(k) = 0;
%             px_prev(k) = px(k);
        else
            px(k) = px(k);
        end
        
        v(k) = sqrt(vx(k)^2 + vy(k)^2);
        v2(k) = v(k).*v(k);
        
        vx_total = vx_total + vx(k);        % Drift velocity x
        vy_total = vy_total + vy(k);        % Drift velocity y
    end
    vx_total_alt = sum(vx);
    for h=1:length(sampleidx)
        subplot(2,1,1);
        plot([px_prev(sampleidx(h)) px(sampleidx(h))],[py_prev(sampleidx(h)) py(sampleidx(h))],'SeriesIndex',h)
        hold on 
    end
    
    
    vx_drift = 1/N * vx_total;
    vy_drift = 1/N * vy_total;
    Jx = C.q_0 * 1e17 * vx_drift;
    Ix_prev = Ix;
    Ix = Jx * (W*L);
    
    
    subplot(2,1,2);
    plot([t-1 t], [Ix_prev Ix], 'r')
    hold on
    
    KE = 0.5 * C.m_n * mean(v2);
    T_prev = T;
    T = KE / C.kb;
%     subplot(2,1,2);
%     plot([t-1 t], [T_prev T],'r')
%     hold on
    
    pause(0.01)
end

T_T_C = mean(ndt);
MFP = mean(v)*mean(ndt);

disp('Section 1')
fprintf(...
'\nFor an applied voltage of %f V across the x dimension, the electric field on the electrons is %e V/m.'...
,V0x,E0x)
fprintf('\n\nWith the electric field of %e V/m, the force on each electron is %e N.',E0x,Fex)
fprintf('\n\nWith the force known, the acceleration of each electron is %e m/s^2.',aex)
fprintf('\n\nThe formula to find current in the x dimension is: Ix = (e*n*v_dx)(W*L)')
fprintf('\nWhere:')
fprintf('\ne is the electron charge')
fprintf('\nn is the concentration of electrons')
fprintf('\nv_dx is the drift velocity of the electrons in the x direction')
fprintf('\nW and L are the region width and length')

%% Section 1.2
% The Monte-Carlo simulation was modified to model the effects of
% acceleration, previously calculated, on the electrons. The result was
% that the electrons were able to respond to the effects of a static
% electric field present in both the x and y axis, represented by the
% acceleration on the particles. The trajectories of the electrons were
% then plotted, where the curve as a result of acceleration can be seen.
% Additionally, the current over time was modelled and displayed. It can be
% seen that the current remains at approximately the same value, due to a
% relatively constant electron drift velocity over time.

subplot(2,1,1);
title('Maxwell-Boltzmann Velocity Distributions of Electrons with Scattering')
xlabel('Region Width (m)')
ylabel('Region Height (m)')
subplot(2,1,2);
title('Current over Time')
xlabel('Timesteps (1e-14 s per step)') 
ylabel('Current (A)')
% disp('Section 2')
% fprintf('\nThe given mean free time between collisions is %e seconds.',Tmn)
% fprintf('\nThe mean calculated time between collisions is %e seconds.',T_T_C)
% fprintf('\nThe mean calculated thermal velocity is %e meters per second.',mean(vth_calc))
% fprintf('\nThe thermal velocity is %e meters per second.',vth)
% fprintf('\nThe mean free path is %e meters.\n\n\n',MFP)
pause(0.1)
saveas(gcf,'Figure1')

%% Section 1.3
% Finally, the temperature and density plots for the simulated region were
% generated.


E_map = [reshape(px,[N,1]),reshape(py,[N,1])];
figure(2)
subplot(1,2,1);
hist3(E_map,'CDataMode','auto','FaceColor','interp')
%view(2)
title('Electron Density in Modeled Region')
xlabel('Region x-Axis (m)')
ylabel('Region y-Axis (m)')
zlabel('Electron Density')


Nbins = 21;
d = 1;
u = 1;
vtm = 0;
vbm = 0;
vbm2 = 0;
T_map = zeros(Nbins);
[X,Xe] = discretize(px,Nbins);
[Y,Ye] = discretize(py,Nbins);

for e=1:Nbins
    for f=1:Nbins
        for g=1:N
            if X(g) == e && Y(g) == f
                vtm(d) = v(g);
                vtm2(d) = vtm(d).*vtm(d);
                d = d+1;
            end
        end
    vbm2 = mean(vtm2);
    d = 1;
    T_map(e,f) = (0.5*C.m_n*vbm2)/C.kb;
    end
end

[V,W] = meshgrid(0:1e-8:2e-7,0:0.5e-8:1e-7);
subplot(1,2,2);
surf(V,W,T_map,'FaceColor','interp')
%view(2)
title('Temperature Map of Modeled Region')
xlabel('Region x-Axis (m)')
ylabel('Region y-Axis (m)')
zlabel('Temperature (K)')
saveas(gcf,'Figure2')

%% Section 2: Finite Difference Method
% Using assignment 2, the finite difference method was used to calculate
% the electric field for the Monte-Carlo bottleneck simulation.

%% Section 2.1
% First, the code from assignment 2 was reused to calculate the potential
% of the region with included bottleneck, shown below. Additionally, the
% electric field of the region was calculated in a quiver plot.

clear all
%close all
clc
%set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Finite Difference Method Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW
% Implement funtion 'pbaspect' to fix Z aspect ratio

L = 200e-9;
W = 100e-9;
V0 = 0.1;

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
%V = sparse(nx,ny);
F = sparse(1,nx*ny);


Acond = 1;              % background conductivity of region, low resistance
Bcond = 1e-2;           % Conductivity of boxes, highly resistive
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
for u = 1:nx
    for v = 1:ny
        if (u >= 80 && u <= 120)
            if v >= 0 && v <= 40
                cMap(u,v) = Bcond;
            elseif v >= 60 && v <= 100
                cMap(u,v) = Bcond;
            else
                cMap(u,v) = Acond;
            end
        else
            cMap(u,v) = Acond;
        end
    end
end





for i = 1:nx                %Iteration through length
    for j = 1:ny            %Iteration through width
        n = j + (i-1)*ny;

        if i == 1          % x=0 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        elseif i == nx     % x=1 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       %F(n)=0 sets z at final width to 0
            
% COMMENT BELOW FOR 1a
            %F(n) = 1;       %F(n)=1 sets z at final width to 1
            
        elseif j == 1                 % y=0 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        elseif j == ny                % y=1 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            
            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            
            
% COMMENT ABOVE FOR 1a
            
        else
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        end
            
    end
end
% figure(1)
% spy(G)

V = G\F';

Vmap = zeros(nx,ny);
for i = 1:nx
    for j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    end
end


for i = 1:nx
    for j = 1:ny
        if i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        elseif i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        else
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        end
        if j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        elseif j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        else
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        end
    end
end

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        %Jx
eFlowy = cMap .* Ey;        %Jy
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

figure(3)
subplot(1, 2, 2), quiver(Ex, Ey);
axis([0 nx 0 ny]);
title('Electric Field Map')
xlabel('Region Length')
ylabel('Region Width')
pbaspect([1 1 0.5])
subplot(1, 2, 1), H = surf(La,Wa,Vmap');
set(H, 'linestyle', 'none');
%view(90, 270)
title('Voltage Map')
xlabel('Region Length')
ylabel('Region Width')
pbaspect([1 1 0.5])
saveas(gcf,'Figure3')

clearvars -except Ex Ey

%% Section 2.2
% Using the calculated electric field as an input to the Monte-Carlo
% simulation, the trajectories of the electrons were then plotted. The
% number of timesteps used in previous simulations was altered from 300 to
% 1000, while the number of electrons (30000) remained unchanged.


%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Beginning Monte Carlo Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);



global C

C.q_0 = 1.60217653e-19;             % electron charge
C.hb = 1.054571596e-34;             % Dirac constant
C.h = C.hb * 2 * pi;                % Planck constant
C.m_0 = 9.10938215e-31;             % electron mass
C.kb = 1.3806504e-23;               % Boltzmann constant
C.eps_0 = 8.854187817e-12;          % vacuum permittivity
C.mu_0 = 1.2566370614e-6;           % vacuum permeability
C.c = 299792458;                    % speed of light
C.g = 9.80665;                      % metres (32.1740 ft) per s
C.m_n = 0.26 * C.m_0;               % effective electron mass
C.am = 1.66053892e-27;              % atomic mass unit
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

figure(4)
subplot(2,1,1);
rectangle('Position',[0 0 200e-9 100e-9])
hold on
rectangle('Position',[0.8e-7 0 0.4e-7 0.4e-7])
hold on
rectangle('Position',[0.8e-7 0.6e-7 0.4e-7 0.4e-7])
hold on

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Initializing Positions
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


N = 30000;        % Number of electrons
i = 0;
j = 0;

for i=1:N
    px(i) = 0 + (200e-9 - 0).*rand(1,1);
    py(i) = 0 + (100e-9 - 0).*rand(1,1);
    while (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && (0 <= py(i) && py(i) <= 0.4e-7) ||...
    (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && (0.6e-7 <= py(i) && py(i) <= 1e-7)
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
    end
end

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Voltage Applied Across x-Dimension to Find Electric Field
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

V0x = 0.1;
V0y = 0;
L = 200e-9;
W = 100e-9;
% E0x = V0x / L;
% E0y = V0y / W;
fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
% G = sparse(nx,ny);
% F = sparse(1,nx*ny);

La = linspace(0,L,nx);
Wa = linspace(0,W,ny);

deltax = L/nx;
deltay = W/ny;

Ex = Ex./deltax;
Ey = Ey./deltay;

% Emapx = zeros(ny,nx);
Emapx = Ex;
% Emapy = zeros(ny,nx);
Emapy = Ey;

% for i = 1:width(La)
%     for j = 1:width(Wa)
%         Emapx(j,i) = E0x;
%         Emapy(j,i) = E0y;
%     end
% end
% %surf(La,Wa,Emapx)
% 
% Fex = abs(C.q_0*E0x);
% aex = Fex/C.m_n;
% Fey = abs(C.q_0*E0y);
% aey = Fey/C.m_n;

Fex = zeros(ny,nx);
aex = zeros(ny,nx);
Fey = zeros(ny,nx);
aey = zeros(ny,nx);

for i = 1:width(Wa)
    for j = 1:width(La)
        Fex(i,j) = abs(C.q_0*Emapx(i,j));
        aex(i,j) = Fex(i,j)/C.m_n;
        Fey(i,j) = abs(C.q_0*Emapy(i,j));
        aey(i,j) = Fey(i,j)/C.m_n;
    end
end
        




%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Thermal Velocity and Direction
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

vth = C.vth;

for j=1:N
    vx(j) = (vth/sqrt(2))*randn();                           
    vy(j) = (vth/sqrt(2))*randn();
    vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
end


t = 0;
T(1) = 0;
dt = 1e-14;     % time step

for l=1:N           %Scattering time step
    ndt(l) = dt;
end
P_scat = 0;
Tmn = 0.2e-12;

px_prev = 0;
py_prev = 0;
T_prev = 0;
vx_total = 0;
vy_total = 0;

sampleidx = randi(N,10,1);
Ix = 0;
Jx = 0;
aex = aex';
aey = aey';

% aex(:,:) = 3e17;    % Testing acceleration
% aey(:,:) = 0;

for t=2:1000
    vx_total = 0;
    vy_total = 0;
    for k=1:N
        
        rpx = 0;
        rpy = 0;
        if px(k) == 200e-9
            px(k) = 0;
            px_prev(k) = px(k);
        elseif px(k) == 0
            px(k) = 200e-9;
            px_prev(k) = px(k);
        else
            px(k) = px(k);
        end

        P_scat(k) = 1 - exp(-(dt/Tmn));
        if P_scat(k) > rand()
            vx(k) = (vth/sqrt(2))*randn();
            vy(k) = (vth/sqrt(2))*randn();
        else
            ndt(k) = ndt(k) + dt;
        end
        
        px_prev(k) = px(k);
        py_prev(k) = py(k);
        
        rpx = round(px(k)*1e9);
        if rpx == 0
            rpx = 1;
        end
        rpy = round(py(k)*1e9);
        if rpy == 0
            rpy = 1;
        end

        
               
        px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        % Adding acceleration
        vx(k) = vx(k) + aex(rpx,rpy)*dt;
        py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
        vy(k) = vy(k) + aey(rpx,rpy)*dt;
        

        % Reflection on top and bottom borders
        if py(k) >= 100e-9 || py(k) <= 0
            vy(k) = -vy(k);
            if py(k) >= 100e-9
                py(k) = 100e-9;
            end
            if py(k) <= 0
                py(k) = 0;
            end
        end
        % Reflection on bottom of upper box
        if (py(k) >= 0.6e-7) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
           && ( 0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vy(k) = -vy(k);
            end
            py(k) = 0.601e-7;
        %end
        % Reflection on top of lower box
        elseif (py(k) <= 0.4e-7) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
               && (0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vy(k) = -vy(k);
            end
            py(k) = 0.399e-7;
        %end
        % Reflection on left of lower box
        elseif (0 <= py(k) && py(k) <= 0.4e-7) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vx(k) = -vx(k);
            end
            px(k) = 0.799e-7;
        %end
        % Reflection on right of lower box
        elseif (0 <= py(k) && py(k) <= 0.4e-7) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vx(k) = -vx(k);
            end
            px(k) = 1.201e-7;
        %end
        % Reflection on left of upper box
        elseif (0.6e-7 <= py(k) && py(k) <= 1e-7) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vx(k) = -vx(k);
            end
            px(k) = 0.799e-7;
        %end
        % Reflection on right of upper box
        elseif (0.6e-7 <= py(k) && py(k) <= 1e-7) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
            if SPECDIFF_BOUND == 1
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                vx(k) = -vx(k);
            end
            px(k) = 1.201e-7;
        end

        % x-axis transition
        if px(k) > 200e-9
            px(k) = 200e-9;
%             px_prev(k) = px(k);
        elseif px(k) < 0
            px(k) = 0;
%             px_prev(k) = px(k);
        else
            px(k) = px(k);
        end
        
        v(k) = sqrt(vx(k)^2 + vy(k)^2);
        v2(k) = v(k).*v(k);
        
        vx_total = vx_total + vx(k);        % Drift velocity x
        vy_total = vy_total + vy(k);        % Drift velocity y
    end
    vx_total_alt = sum(vx);
    for h=1:length(sampleidx)
        subplot(2,1,1);
        plot([px_prev(sampleidx(h)) px(sampleidx(h))],[py_prev(sampleidx(h)) py(sampleidx(h))],'SeriesIndex',h)
        hold on 
    end
    
    
    vx_drift = 1/N * vx_total;
    vy_drift = 1/N * vy_total;
    Jx = C.q_0 * 1e17 * vx_drift;
    Ix_prev = Ix;
    Ix = Jx * (W*L);
    Ix_total(t) = Ix;
    
    
    subplot(2,1,2);
    plot([t-1 t], [Ix_prev Ix], 'r')
    hold on
    
    KE = 0.5 * C.m_n * mean(v2);
    T_prev = T;
    T = KE / C.kb;
%     subplot(2,1,2);
%     plot([t-1 t], [T_prev T],'r')
%     hold on
    
    pause(0.01)
end

T_T_C = mean(ndt);
MFP = mean(v)*mean(ndt);

subplot(2,1,1);
title('Maxwell-Boltzmann Velocity Distributions of Electrons with Scattering')
xlabel('Region Length (m)')
ylabel('Region Width (m)')
subplot(2,1,2);
title('Current over Time')
xlabel('Timesteps (1e-14 s per step)') 
ylabel('Current (A)')
% disp('Section 2')
% fprintf('\nThe given mean free time between collisions is %e seconds.',Tmn)
% fprintf('\nThe mean calculated time between collisions is %e seconds.',T_T_C)
% fprintf('\nThe mean calculated thermal velocity is %e meters per second.',mean(vth_calc))
% fprintf('\nThe thermal velocity is %e meters per second.',vth)
% fprintf('\nThe mean free path is %e meters.\n\n\n',MFP)
pause(0.1)
saveas(gcf,'Figure4')

%% Section 3: Basic Parameter Extraction
% Various operations of the simulation were examined to observe the
% function of the model, beginning with a density plot.

%% Section 3.1
% First, the electron density map was plotted. It can be seen that the
% bottleneck severly restricts the flow of electrons, resulting in a
% greater concentration on the left side of the block, where the
% acceleration has forced the particles due to the transition from the
% right border of the model to the left.


E_map = [reshape(px,[N,1]),reshape(py,[N,1])];
figure(5)
hist3(E_map,'CDataMode','auto','FaceColor','interp')
%view(2)
title('Electron Density in Modeled Region')
xlabel('Region x-Axis (m)')
ylabel('Region y-Axis (m)')
zlabel('Electron Density')
saveas(gcf,'Figure5')

%% Section 3.2
% To begin, the number of time steps was reduced from 1000 back to the
% original value of 300, as the next simulation was noted to require a
% large amount of time. The simulation modelled the effects of varying
% bottleneck widths, and the result was compared to the average current. It
% can be seen that an increase in the bottleneck gap corresponds to an
% increase in the average current.
%
% The next step in making the simulation more accurate would be to model
% the y-dimension more accurately. At present, the current and drift only
% account for the x-dimension, despite an electric field also existing in
% the y-dimension. Updating the model to account for this would result in a
% better representation of the particle flows.

clear all
%close all
clc
%set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Finite Difference Method Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
for J=1:10
g = J*1e-9;
% Solving V=V0 @ x=0 and V=0 @ x=L in region LxW
% Implement funtion 'pbaspect' to fix Z aspect ratio
clearvars -except bottleneck g J Ix_total Iavg

L = 200e-9;
W = 100e-9;
V0 = 0.1;

fMesh = 1;
nx = fMesh*200;
ny = fMesh*100;
La = linspace(0,L,nx);
Wa = linspace(0,W,ny);
G = sparse(nx*ny);
%V = sparse(nx,ny);
F = sparse(1,nx*ny);


Acond = 1;              % background conductivity of region, low resistance
Bcond = 1e-2;           % Conductivity of boxes, highly resistive
cMap = zeros(nx,ny);
Lb = 40e-9;
Wb = 40e-9;
for u = 1:nx
    for v = 1:ny
        if (u >= 80 && u <= 120)
            if v >= 0 && v <= 40-1+J
                cMap(u,v) = Bcond;
            elseif v >= 60+1-J && v <= 100
                cMap(u,v) = Bcond;
            else
                cMap(u,v) = Acond;
            end
        else
            cMap(u,v) = Acond;
        end
    end
end





for i = 1:nx                %Iteration through length
    for j = 1:ny            %Iteration through width
        n = j + (i-1)*ny;

        if i == 1          % x=0 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = V0;
        elseif i == nx     % x=1 BCs
            G(n,:) = 0;
            G(n,n) = 1;
            F(n) = 0;       %F(n)=0 sets z at final width to 0
            
% COMMENT BELOW FOR 1a
            %F(n) = 1;       %F(n)=1 sets z at final width to 1
            
        elseif j == 1                 % y=0 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nyp) = ryp;

        elseif j == ny                % y=1 BCs
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            
            G(n,n) = -(rxm+rxp+rym);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            
            
% COMMENT ABOVE FOR 1a
            
        else
            nxm = j + (i-2)*ny;
            nxp = j + (i)*ny;
            nym = j-1 + (i-1)*ny;
            nyp = j+1 + (i-1)*ny;

            rxm = (cMap(i,j) + cMap(i-1,j))/2;
            rxp = (cMap(i,j) + cMap(i+1,j))/2;
            rym = (cMap(i,j) + cMap(i,j-1))/2;
            ryp = (cMap(i,j) + cMap(i,j+1))/2;
            
            G(n,n) = -(rxm+rxp+rym+ryp);
            G(n,nxm) = rxm;
            G(n,nxp) = rxp;
            G(n,nym) = rym;
            G(n,nyp) = ryp;
        end
            
    end
end
% figure(1)
% spy(G)

V = G\F';

Vmap = zeros(nx,ny);
for i = 1:nx
    for j = 1:ny
        n = j + (i-1)*ny;
        Vmap(i,j) = V(n);
    end
end


for i = 1:nx
    for j = 1:ny
        if i == 1
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i, j));
        elseif i == nx
            Ex(i, j) = (Vmap(i, j) - Vmap(i - 1, j));
        else
            Ex(i, j) = (Vmap(i + 1, j) - Vmap(i - 1, j)) * 0.5;
        end
        if j == 1
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j));
        elseif j == ny
            Ey(i, j) = (Vmap(i, j) - Vmap(i, j - 1));
        else
            Ey(i, j) = (Vmap(i, j + 1) - Vmap(i, j - 1)) * 0.5;
        end
    end
end

Ex = -Ex;
Ey = -Ey;

eFlowx = cMap .* Ex;        %Jx
eFlowy = cMap .* Ey;        %Jy
C0 = sum(eFlowx(1, :));
Cnx = sum(eFlowx(nx, :));
Curr = (C0 + Cnx) * 0.5;

Ex = Ex';
Ey = Ey';

% figure(4)
% subplot(1, 2, 2), quiver(Ex, Ey);
% axis([0 nx 0 ny]);
% title('Electric Field Map')
% xlabel('Region Length')
% ylabel('Region Width')
% pbaspect([1 1 0.5])
% subplot(1, 2, 1), H = surf(La,Wa,Vmap');
% set(H, 'linestyle', 'none');
% %view(90, 270)
% title('Voltage Map')
% xlabel('Region Length')
% ylabel('Region Width')
% pbaspect([1 1 0.5])
% saveas(gcf,'Figure4')

% clearvars -except Ex Ey

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Beginning Monte Carlo Simulation
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH


set(0,'DefaultFigureWindowStyle','docked')
set(0,'defaultaxesfontsize',10)
set(0,'defaultaxesfontname','Times New Roman')
set(0,'DefaultLineLineWidth', 0.5);



global C

C.q_0 = 1.60217653e-19;             % electron charge
C.hb = 1.054571596e-34;             % Dirac constant
C.h = C.hb * 2 * pi;                % Planck constant
C.m_0 = 9.10938215e-31;             % electron mass
C.kb = 1.3806504e-23;               % Boltzmann constant
C.eps_0 = 8.854187817e-12;          % vacuum permittivity
C.mu_0 = 1.2566370614e-6;           % vacuum permeability
C.c = 299792458;                    % speed of light
C.g = 9.80665;                      % metres (32.1740 ft) per s
C.m_n = 0.26 * C.m_0;               % effective electron mass
C.am = 1.66053892e-27;              % atomic mass unit
C.T = 300;
C.vth = sqrt(2*C.kb * C.T / C.m_n);

temp = C.T;

SPECDIFF_BOUND = 0;

% figure(3)
% subplot(2,1,1);
% rectangle('Position',[0 0 200e-9 100e-9])
% hold on
% rectangle('Position',[0.8e-7 0 0.4e-7 0.4e-7])
% hold on
% rectangle('Position',[0.8e-7 0.6e-7 0.4e-7 0.4e-7])
% hold on

%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
% Initializing Positions
%REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    N = 30000;        % Number of electrons
    i = 0;
    j = 0;

    for i=1:N
        px(i) = 0 + (200e-9 - 0).*rand(1,1);
        py(i) = 0 + (100e-9 - 0).*rand(1,1);
        while (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && (0 <= py(i) && py(i) <= (0.4e-7 -1e-9 +g) ) ||...
                (0.8e-7 <= px(i) && px(i) <= 1.2e-7) && ((0.6e-7 +1e-9 -g) <= py(i) && py(i) <= 1e-7)
            px(i) = 0 + (200e-9 - 0).*rand(1,1);
            py(i) = 0 + (100e-9 - 0).*rand(1,1);
        end
    end

    %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
    % Voltage Applied Across x-Dimension to Find Electric Field
    %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    V0x = 0.1;
    V0y = 0;
    L = 200e-9;
    W = 100e-9;
    % E0x = V0x / L;
    % E0y = V0y / W;
    fMesh = 1;
    nx = fMesh*200;
    ny = fMesh*100;
    % G = sparse(nx,ny);
    % F = sparse(1,nx*ny);

    La = linspace(0,L,nx);
    Wa = linspace(0,W,ny);

    deltax = L/nx;
    deltay = W/ny;

    Ex = Ex./deltax;
    Ey = Ey./deltay;

    % Emapx = zeros(ny,nx);
    Emapx = Ex;
    % Emapy = zeros(ny,nx);
    Emapy = Ey;

    % for i = 1:width(La)
    %     for j = 1:width(Wa)
    %         Emapx(j,i) = E0x;
    %         Emapy(j,i) = E0y;
    %     end
    % end
    % %surf(La,Wa,Emapx)
    %
    % Fex = abs(C.q_0*E0x);
    % aex = Fex/C.m_n;
    % Fey = abs(C.q_0*E0y);
    % aey = Fey/C.m_n;

    Fex = zeros(ny,nx);
    aex = zeros(ny,nx);
    Fey = zeros(ny,nx);
    aey = zeros(ny,nx);

    for i = 1:width(Wa)
        for j = 1:width(La)
            Fex(i,j) = abs(C.q_0*Emapx(i,j));
            aex(i,j) = Fex(i,j)/C.m_n;
            Fey(i,j) = abs(C.q_0*Emapy(i,j));
            aey(i,j) = Fey(i,j)/C.m_n;
        end
    end





    %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH
    % Thermal Velocity and Direction
    %REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH

    vth = C.vth;

    for j=1:N
        vx(j) = (vth/sqrt(2))*randn();
        vy(j) = (vth/sqrt(2))*randn();
        vth_calc(j) = sqrt(vx(j)^2 + vy(j)^2);
    end


    t = 0;
    T(1) = 0;
    dt = 1e-14;     % time step

    for l=1:N           %Scattering time step
        ndt(l) = dt;
    end
    P_scat = 0;
    Tmn = 0.2e-12;

    px_prev = 0;
    py_prev = 0;
    T_prev = 0;
    vx_total = 0;
    vy_total = 0;

    sampleidx = randi(N,10,1);
    Ix = 0;
    Jx = 0;
    aex = aex';
    aey = aey';




    for t=2:300
        vx_total = 0;
        vy_total = 0;
        for k=1:N

            rpx = 0;
            rpy = 0;
            if px(k) == 200e-9
                px(k) = 0;
                px_prev(k) = px(k);
            elseif px(k) == 0
                px(k) = 200e-9;
                px_prev(k) = px(k);
            else
                px(k) = px(k);
            end

            P_scat(k) = 1 - exp(-(dt/Tmn));
            if P_scat(k) > rand()
                vx(k) = (vth/sqrt(2))*randn();
                vy(k) = (vth/sqrt(2))*randn();
            else
                ndt(k) = ndt(k) + dt;
            end

            px_prev(k) = px(k);
            py_prev(k) = py(k);

            rpx = round(px(k)*1e9);
            if rpx == 0
                rpx = 1;
            end
            rpy = round(py(k)*1e9);
            if rpy == 0
                rpy = 1;
            end



            px(k) = px(k) + vx(k)*dt + aex(rpx,rpy)*dt^2;        % Adding acceleration
            vx(k) = vx(k) + aex(rpx,rpy)*dt;
            py(k) = py(k) + vy(k)*dt + aey(rpx,rpy)*dt^2;
            vy(k) = vy(k) + aey(rpx,rpy)*dt;


            % Reflection on top and bottom borders
            if py(k) >= 100e-9 || py(k) <= 0
                vy(k) = -vy(k);
                if py(k) >= 100e-9
                    py(k) = 100e-9;
                end
                if py(k) <= 0
                    py(k) = 0;
                end
            end
            % Reflection on bottom of upper box
            if (py(k) >= (0.6e-7 +1e-9 -g)) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
                    && ( 0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vy(k) = -vy(k);
                end
                py(k) = 0.601e-7 +1e-9 -g;
                %end
                % Reflection on top of lower box
            elseif (py(k) <= 0.4e-7 -1e-9 +g) && (0.8e-7 <= px(k) && px(k) <= 1.2e-7)...
                    && (0.8e-7 <= px_prev(k) && px_prev(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vy(k) = -vy(k);
                end
                py(k) = 0.399e-7 -1e-9 +g;
                %end
                % Reflection on left of lower box
            elseif (0 <= py(k) && py(k) <= 0.4e-7) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 0.799e-7;
                %end
                % Reflection on right of lower box
            elseif (0 <= py(k) && py(k) <= 0.4e-7) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 1.201e-7;
                %end
                % Reflection on left of upper box
            elseif (0.6e-7 <= py(k) && py(k) <= 1e-7) && (0.8e-7 <= px(k) && px(k) <= 1e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 0.799e-7;
                %end
                % Reflection on right of upper box
            elseif (0.6e-7 <= py(k) && py(k) <= 1e-7) && (1e-7 <= px(k) && px(k) <= 1.2e-7)
                if SPECDIFF_BOUND == 1
                    vx(k) = (vth/sqrt(2))*randn();
                    vy(k) = (vth/sqrt(2))*randn();
                else
                    vx(k) = -vx(k);
                end
                px(k) = 1.201e-7;
            end

            % x-axis transition
            if px(k) > 200e-9
                px(k) = 200e-9;
                %             px_prev(k) = px(k);
            elseif px(k) < 0
                px(k) = 0;
                %             px_prev(k) = px(k);
            else
                px(k) = px(k);
            end

            v(k) = sqrt(vx(k)^2 + vy(k)^2);
            v2(k) = v(k).*v(k);

            vx_total = vx_total + vx(k);        % Drift velocity x
            vy_total = vy_total + vy(k);        % Drift velocity y
        end
        vx_total_alt = sum(vx);



        vx_drift = 1/N * vx_total;
        vy_drift = 1/N * vy_total;
        Jx = C.q_0 * 1e17 * vx_drift;
        Ix_prev = Ix;
        Ix = Jx * (W*L);
        Ix_total(t) = Ix;



    end

    
    Iavg(J) = mean(Ix_total);
    bottleneck(J) = 20e-9 - (2*g) + 2e-9;


end

figure(6)
plot(bottleneck,Iavg)
xlabel('Bottleneck Length(m)')
ylabel('Average Current (A)')
title('Average Current VS Bottleneck Length')
saveas(gcf,'Figure6')



##### SOURCE END #####
--></body></html>